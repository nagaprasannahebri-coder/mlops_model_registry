name: Snowflake Model Registry End-to-End Pipeline

on:
  workflow_dispatch:

jobs:
  run-snowflake-cli:
    runs-on: ubuntu-latest
    name: Trigger Tasks ‚Üí Fetch Latest Model from Registry ‚Üí Export ‚Üí Upload

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install Snowflake CLI (Dev build with ML plugin)
      - name: Install Snowflake CLI with ML support
        run: |
          echo "üß∞ Installing latest Snowflake CLI dev build..."
          pip install --upgrade git+https://github.com/snowflakedb/snowflake-cli.git@main
          echo "‚úÖ Installed CLI version:"
          snow --version
          echo "‚úÖ Checking ML plugin availability..."
          snow --help | grep -E "ml|model" || echo "‚ö†Ô∏è ML plugin may not be fully loaded!"

      # 3Ô∏è‚É£ Configure Snowflake credentials
      - name: Configure Snowflake credentials
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          mkdir -p ~/.snowflake
          cat <<EOF > ~/.snowflake/config.toml
          [connections.default]
          account = "${SNOWFLAKE_ACCOUNT}"
          user = "${SNOWFLAKE_USER}"
          password = "${SNOWFLAKE_PASSWORD}"
          role = "${SNOWFLAKE_ROLE}"
          warehouse = "${SNOWFLAKE_WAREHOUSE}"
          database = "${SNOWFLAKE_DATABASE}"
          schema = "${SNOWFLAKE_SCHEMA}"
          EOF
          chmod 600 ~/.snowflake/config.toml
          echo "‚úÖ Snowflake config.toml ready."

      # 4Ô∏è‚É£ Trigger ML pipeline (execute root task)
      - name: Trigger Snowflake ML pipeline
        run: |
          echo "üöÄ Executing Snowflake ML pipeline..."
          snow sql -q "USE WAREHOUSE MLOPS_WH; USE DATABASE POWERCONSUMPTION; USE SCHEMA PUBLIC; EXECUTE TASK TASK_1_DATA_INGESTION;"
          echo "‚úÖ Task chain triggered successfully."

      # 5Ô∏è‚É£ Wait and verify task status
      - name: Verify task execution
        run: |
          echo "‚è≥ Waiting 15 seconds before checking task status..."
          sleep 15
          snow sql -q "USE DATABASE POWERCONSUMPTION; USE SCHEMA PUBLIC; SHOW TASKS LIKE 'TASK_1_DATA_INGESTION';" --format table
          echo "‚úÖ Task status verified."

      # 6Ô∏è‚É£ Identify latest registered model
      - name: Identify latest model from registry
        run: |
          echo "üì¶ Identifying latest registered model..."
          mkdir -p models
          latest_model=$(snow sql -q "SHOW MODELS IN SCHEMA PUBLIC;" --format csv \
            | grep POWER_CONSUMPTION_MODEL \
            | sort -t',' -k1,1r \
            | head -n1 \
            | cut -d',' -f2 \
            | tr -d '"')
          if [ -z "$latest_model" ]; then
            echo "‚ùå No models found in registry!"
            exit 1
          fi
          echo "‚úÖ Latest model: $latest_model"
          echo "LATEST_MODEL=$latest_model" >> $GITHUB_ENV

      # 7Ô∏è‚É£ Try exporting via CLI, fallback to SQL if CLI plugin unavailable
      - name: Export model from registry
        run: |
          echo "üì§ Attempting to export model $LATEST_MODEL..."
          mkdir -p models
          if snow ml --help >/dev/null 2>&1; then
            echo "‚úÖ ML plugin detected. Exporting directly via CLI..."
            snow ml model export "$LATEST_MODEL" --file-format onnx --output-dir ./models
          else
            echo "‚ö†Ô∏è snow ml not found. Falling back to SYSTEM\$EXPORT_MODEL..."
            snow sql -q "USE DATABASE POWERCONSUMPTION; USE SCHEMA PUBLIC; CALL SYSTEM\$EXPORT_MODEL('$LATEST_MODEL', '@ML_MODELS_STAGE');"
            echo "üì• Fetching latest ONNX model from @ML_MODELS_STAGE..."
            latest_file=$(snow sql -q "LIST @ML_MODELS_STAGE PATTERN='.*\\.onnx'" --format csv | sort -t',' -k4,4r | head -n1 | cut -d',' -f1)
            if [ -z "$latest_file" ]; then
              echo "‚ùå No ONNX file found in stage!"
              exit 1
            fi
            snow sql -q "GET @$latest_file file://./models/"
          fi
          echo "‚úÖ Model export complete."

      # 8Ô∏è‚É£ Verify exported model files
      - name: Verify exported ONNX model
        run: |
          if ls models/*.onnx 1>/dev/null 2>&1; then
            echo "‚úÖ Model file(s) found:"
            ls -lh models
          else
            echo "‚ùå No ONNX model exported!"
            exit 1
          fi

      # 9Ô∏è‚É£ Upload model artifact
      - name: Upload exported model
        uses: actions/upload-artifact@v4
        with:
          name: exported-onnx-model
          path: models/
          retention-days: 7

      # üîü Final summary
      - name: Summary
        run: |
          echo "‚úÖ End-to-end Snowflake Model Registry pipeline completed!"
          echo "‚úÖ Latest model exported and uploaded as artifact!"
