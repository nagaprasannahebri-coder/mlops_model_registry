name: Snowflake CLI End-to-End ML Pipeline

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  run-snowflake-cli:
    runs-on: ubuntu-latest
    name: Trigger ML Pipeline ‚Üí Check Status ‚Üí Fetch Latest Model ‚Üí Upload Artifact

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install Snowflake CLI (modern `snow` CLI)
      - name: üß∞ Install Snowflake CLI
        uses: snowflakedb/snowflake-cli-action@v2.0
        with:
          custom-github-ref: "main"

      # 3Ô∏è‚É£ Add Snowflake CLI to PATH
      - name: ü©µ Add Snowflake CLI to PATH
        run: echo "/home/runner/.local/share/uv/tools/snowflake-cli/bin" >> $GITHUB_PATH

      # 4Ô∏è‚É£ Configure Snowflake connection (secure config.toml)
      - name: ‚öôÔ∏è Setup Snowflake Config
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          mkdir -p ~/.snowflake
          cat <<EOF > ~/.snowflake/config.toml
          [connections.default]
          account = "${SNOWFLAKE_ACCOUNT}"
          user = "${SNOWFLAKE_USER}"
          password = "${SNOWFLAKE_PASSWORD}"
          role = "${SNOWFLAKE_ROLE}"
          warehouse = "${SNOWFLAKE_WAREHOUSE}"
          database = "${SNOWFLAKE_DATABASE}"
          schema = "${SNOWFLAKE_SCHEMA}"
          EOF
          chmod 600 ~/.snowflake/config.toml
          echo "‚úÖ Snowflake config.toml created."

      # 5Ô∏è‚É£ Verify CLI installation
      - name: üîç Verify Snowflake CLI Installation
        run: |
          echo "üîç Checking Snowflake CLI installation..."
          which snow || { echo "‚ùå CLI not found in PATH"; exit 1; }
          snow --version
          echo "‚úÖ Snowflake CLI verified."

      # 6Ô∏è‚É£ Trigger the ML pipeline task
      - name: üöÄ Trigger Snowflake ML Pipeline
        run: |
          echo "üöÄ Executing ML pipeline task..."
          snow sql -q "USE WAREHOUSE MLOPS_WH; USE DATABASE POWERCONSUMPTION; USE SCHEMA PUBLIC; EXECUTE TASK TASK_1_DATA_INGESTION;"
          echo "‚úÖ ML pipeline triggered successfully!"

      # 7Ô∏è‚É£ Wait for task completion
      - name: ‚è≥ Wait for pipeline completion
        run: |
          echo "‚è≥ Waiting 15 seconds before checking task status..."
          sleep 15

      # 8Ô∏è‚É£ Check Snowflake task execution status
      - name: üìä Check Task Execution Status
        run: |
          echo "üìä Checking task status in Snowflake..."
          snow sql -q "USE DATABASE POWERCONSUMPTION; USE SCHEMA PUBLIC; SHOW TASKS LIKE 'TASK_1_DATA_INGESTION';" --format table
          echo "‚úÖ Task status fetched successfully."

      # 9Ô∏è‚É£ Fetch the latest ONNX model using true timestamp order
      - name: üì• Fetch and Download Latest ONNX Model
        run: |
          echo "üìú Fetching latest ONNX model by actual timestamp..."
          mkdir -p models
          latest_model=$(snow sql -q "SELECT METADATA\$FILENAME FROM DIRECTORY(@ML_MODELS_STAGE) WHERE METADATA\$FILENAME LIKE '%.onnx' ORDER BY METADATA\$LAST_MODIFIED DESC LIMIT 1;" --format csv | tail -n +2 | tr -d '"')
          if [ -z "$latest_model" ]; then
            echo "‚ùå No ONNX files found in @ML_MODELS_STAGE!"
            exit 1
          fi
          echo "‚úÖ Latest model detected: $latest_model"
          snow sql -q "GET @ML_MODELS_STAGE/$latest_model file://./models/"
          echo "‚úÖ Model downloaded successfully."

      # üîü Verify model file presence
      - name: üîç Verify Model Download
        run: |
          if ls models/*.onnx 1> /dev/null 2>&1; then
            echo "‚úÖ Model file(s) found in ./models:"
            ls -lh models
          else
            echo "‚ùå No ONNX model files found in ./models!"
            exit 1
          fi

      # 11Ô∏è‚É£ Upload model artifact to GitHub
      - name: üì¶ Upload ONNX Model Artifact
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-onnx-model
          path: models/
          retention-days: 7

      # ‚úÖ Final Summary
      - name: üìú Summary
        run: echo "‚úÖ End-to-end Snowflake pipeline executed, task verified, and latest model uploaded successfully!"


