name: MLOps Model Registry Pipeline

on:
  workflow_dispatch:      # Manual trigger button
  push:
    branches: [ main ]    # Auto-trigger on code changes

jobs:
  deploy-pipeline:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          pip install --no-cache-dir -r requirements.txt
          pip install snowflake-connector-python python-dotenv

      # 4Ô∏è‚É£ Trigger Snowflake ML Pipeline
      - name: Trigger ML Pipeline in Snowflake
        env:
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_WAREHOUSE: ${{ vars.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ vars.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ vars.SNOWFLAKE_SCHEMA }}
        run: |
          python trigger_pipeline.py

      # 5Ô∏è‚É£ Build Docker image for model serving
      - name: Build Docker Image
        run: docker build -t baseline-model-api .

      # 6Ô∏è‚É£ Run container and test API
      - name: Run and Health Check
        run: |
          docker run -d -p 8055:8055 \
            -e SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }} \
            -e SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }} \
            -e SNOWFLAKE_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT }} \
            -e SNOWFLAKE_WAREHOUSE=${{ vars.SNOWFLAKE_WAREHOUSE }} \
            -e SNOWFLAKE_DATABASE=${{ vars.SNOWFLAKE_DATABASE }} \
            -e SNOWFLAKE_SCHEMA=${{ vars.SNOWFLAKE_SCHEMA }} \
            -e SNOWFLAKE_STAGE=${{ vars.SNOWFLAKE_STAGE }} \
            baseline-model-api

          echo "‚è≥ Waiting for API to start..."
          sleep 25

          echo "ü©∫ Checking health endpoint..."
          for i in {1..10}; do
            if curl -s http://127.0.0.1:8055/ | grep -q "ok"; then
              echo "‚úÖ API is healthy!"
              exit 0
            fi
            echo "Attempt $i: not ready yet..."
            sleep 5
          done
          echo "‚ùå API did not respond after retries."
          exit 1

      # 7Ô∏è‚É£ (Optional) Push image to GitHub Container Registry
      - name: Push Image to GHCR
        if: success()
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker tag baseline-model-api ghcr.io/${{ github.repository_owner }}/baseline-model-api:latest
          docker push ghcr.io/${{ github.repository_owner }}/baseline-model-api:latest

